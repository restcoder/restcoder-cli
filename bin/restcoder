#!/usr/bin/env node
'use strict';

process.bin = process.title = 'restcoder';

const prompt = require('prompt');
const co = require('co');
const updateNotifier = require('update-notifier');
const pkg = require('../package.json');
const program = require('commander');
const _ = require('underscore');
const ConfigService = require('../src/services/ConfigService');
const CodeService = require('../src/services/CodeService');
const APIService = require('../src/services/APIService');
const StartService = require('../src/services/StartService');


function _checkLoggedIn() {
  if (!ConfigService.isAuthenticated()) {
    throw new Error("Your are not authenticated. Please use the 'restcoder login' command.");
  }
}

function _wrapCommand(fn) {
  return function () {
    const args = arguments;
    co(function*() {
      const binded = Function.prototype.bind.apply(fn, _.flatten([null, args]));
      yield binded();
      process.exit(0);
    }).catch(e => {
      console.log('ERR!'.red, e.message);
      if (process.env.RESTCODER_CLI_LOCAL_MODE) {
        console.log(e.stack);
      }
      process.exit(1);
    });
  };
}

program
  .version(pkg.version)
  .command('init <problemId> [directory]')
  .description('init source code in current directory')
  .action(_wrapCommand(function*(problemId, directory) {
    _checkLoggedIn();
    yield CodeService.initCode(problemId, directory);
  }));

program
  .command('submit')
  .description('Submit your source code and test your solution')
  .action(_wrapCommand(function*() {
    _checkLoggedIn();
    yield CodeService.submit(process.cwd());
  }));

program
  .command('start')
  .description('Start your application locally')
  .action(() => {
    const port = 5000;
    StartService.start(port, process.cwd());
  });

program
  .command('login')
  .description('login with your username and password')
  .action(_wrapCommand(function*() {
    const params = [{
      name: 'username',
      description: 'Your username:',
      required: true
    }, {
      name: 'password',
      description: 'Your password:',
      hidden: true,
      required: true
    }];

    const bindedPrompt = prompt.get.bind(prompt, params);
    let result;
    try {
      result = yield bindedPrompt;
    } catch (err) {
      if (err.message === 'canceled') {
        process.exit();
      } else {
        throw err;
      }
    }
    const data = yield APIService.login(result.username, result.password);
    const settings = ConfigService.getSettings();
    settings.user = {
      username: result.username,
      token: data.token
    };
    ConfigService.updateSettings(settings);
    console.log('Authenticated successfully');
  }));


// unknown command
// display help
program.action(() => {
  program.outputHelp();
});

program.parse(process.argv);
if (process.argv.length === 2) {
  program.outputHelp();
}

// check for update
updateNotifier({ pkg, updateCheckInterval: 0 }).notify();
